trigger:
  - main

pr:
  - main

pool:
  name: Default

steps:
  - checkout: self

  # Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Setup Node.js'

  # Install dependencies
  - script: npm ci
    displayName: 'Install npm packages'
    workingDirectory: '$(Build.SourcesDirectory)'

  # Build React app
  - script: npm run build
    displayName: 'Build React app'
    workingDirectory: '$(Build.SourcesDirectory)'

  # Deploy to Azure Static Web Apps
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Azure-Service-Connection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Use correct Azure CLI user folder
        $env:AZURE_CONFIG_DIR = "C:\Users\baina\.azure"

        # Do NOT allow Azure CLI to auto-install system extensions
        az config set extension.use_dynamic_install=no
        az config set extension.run_after_dynamic_install=no

        Write-Host "Detected SWA extension:"
        az extension list

        # Deploy build folder
        az staticwebapp upload `
          --name localShopWebApp `
          --resource-group localShopRG `
          --source "$(Build.SourcesDirectory)\build"

    displayName: 'Deploy to Azure Static Web Apps'
