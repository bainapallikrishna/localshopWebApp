trigger:
- main

pr:
- main

pool:
  name: Default

steps:
- checkout: self

# Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Setup Node.js'

# Install dependencies
- script: npm ci
  workingDirectory: '$(Build.SourcesDirectory)'
  displayName: 'Install npm packages'

# Build React
- script: npm run build
  workingDirectory: '$(Build.SourcesDirectory)'
  displayName: 'Build React app'

# Deploy to SWA
- task: AzureCLI@2
  inputs:
    azureSubscription: 'localshopwebapp'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "Fetching SWA deployment token..."
      $token = az staticwebapp secrets list `
        --name localShopWebApp `
        --resource-group localShopRG `
        --query properties.apiKey -o tsv

      if (-not $token) {
        Write-Error "Failed to retrieve deployment token"
        exit 1
      }

      Write-Host "Token OK"

      # Deployment host
      $deployHost = "purple-coast-0b51eec00.build.azurestaticapps.net"

      # ZIP build output
      $zipPath = "$(Build.SourcesDirectory)\build.zip"
      if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

      Add-Type -AssemblyName System.IO.Compression.FileSystem

      # FIXED: One-line CreateFromDirectory call
      [System.IO.Compression.ZipFile]::CreateFromDirectory("$(Build.SourcesDirectory)\build", $zipPath)

      Write-Host "ZIP ready"

      # Final deploy URL
      $deployUrl = "https://$deployHost/api/build/deploy?api_token=$token"
      Write-Host "Deploying to $deployUrl"

      Invoke-RestMethod -Uri $deployUrl `
        -Method POST `
        -InFile $zipPath `
        -ContentType "application/octet-stream"

      Write-Host "ðŸŽ‰ Deployment SUCCESS!"
  displayName: 'Deploy to Azure Static Web Apps'
