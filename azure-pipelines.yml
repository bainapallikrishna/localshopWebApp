trigger:
  - main

pr:
  - main

pool:
  name: Default

steps:
  - checkout: self

  # Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Setup Node.js'

  # Install dependencies
  - script: npm ci
    displayName: 'Install npm packages'
    workingDirectory: '$(Build.SourcesDirectory)'

  # Build the React app
  - script: npm run build
    displayName: 'Build React app'
    workingDirectory: '$(Build.SourcesDirectory)'

  # Deploy to Azure Static Web Apps
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Azure-Service-Connection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Fetching Static Web App deployment token..."
        $token = az staticwebapp secrets list `
          --name localShopWebApp `
          --resource-group localShopRG `
          --query properties.apiKey `
          -o tsv

        if (-not $token) {
            Write-Error "ERROR: Failed to retrieve SWA deployment token"
            exit 1
        }

        Write-Host "Token retrieved."

        # Use correct hostname (you provided this)
        $hostname = "purple-coast-0b51eec00.3.azurestaticapps.net"
        Write-Host "Deploying to hostname: $hostname"

        # ZIP build folder
        Write-Host "Zipping build output..."
        $zipPath = "$(Build.SourcesDirectory)\build.zip"

        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::CreateFromDirectory("$(Build.SourcesDirectory)\build", $zipPath)

        Write-Host "ZIP created at: $zipPath"

        # Deployment endpoint
        $deployUrl = "https://$hostname/api/zipdeploy?api_token=$token"
        Write-Host "Deploying to: $deployUrl"

        # Upload the ZIP
        Invoke-RestMethod `
          -Uri $deployUrl `
          -Method POST `
          -InFile $zipPath `
          -ContentType "application/zip"

        Write-Host "ðŸŽ‰ Deployment SUCCESSFUL!"
    displayName: 'Deploy to Azure Static Web Apps'
