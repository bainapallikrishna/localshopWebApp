trigger:
  - main

pr:
  - main

pool:
  name: Default   # self-hosted Windows agent

steps:
  - checkout: self
    submodules: true

  # Install Node.js
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Setup Node.js'

  # Install dependencies
  - script: |
      npm ci
    displayName: 'Install dependencies'

  # Build the app
  - script: |
      npm run build
    displayName: 'Build application'

  # Install Azure CLI (only needed if your agent doesnâ€™t have AZ CLI)
  - powershell: |
      if (-not (Get-Command az -ErrorAction SilentlyContinue)) {
        Write-Host "Azure CLI not found. Installing..."
        Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile .\AzureCLI.msi
        Start-Process msiexec.exe -ArgumentList "/I AzureCLI.msi /quiet" -Wait
      }
      az --version
    displayName: "Ensure Azure CLI Installed"

  # Deploy manually using AZ CLI (NO DOCKER NEEDED)
  - task: AzureCLI@2
    inputs:
      azureSubscription: "Azure-Service-Connection"
      scriptType: "ps"
      scriptLocation: "inlineScript"
      inlineScript: |
        az staticwebapp upload `
          --name localShopWebApp `
          --resource-group localShopRG `
          --source build `
          --verbose
    displayName: "Deploy to Azure Static Web Apps"
