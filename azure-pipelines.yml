trigger:
- main

pr:
- main

pool:
  name: Default   # your self-hosted Windows agent

steps:
- checkout: self

# Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Setup Node.js'

# Install dependencies
- script: npm ci
  workingDirectory: '$(Build.SourcesDirectory)'
  displayName: 'Install npm packages'

# Build React
- script: npm run build
  workingDirectory: '$(Build.SourcesDirectory)'
  displayName: 'Build React app'

# Deploy using SWA CLI (works on Windows)
- task: AzureCLI@2
  displayName: "Deploy to Azure Static Web Apps"
  inputs:
    azureSubscription: 'localshopwebapp'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      Write-Host "Fetching deployment token..."
      $token = az staticwebapp secrets list `
        --name localShopWebApp `
        --resource-group localShopRG `
        --query properties.apiKey -o tsv

      if (-not $token) {
        Write-Error "Failed to retrieve SWA token"
        exit 1
      }

      Write-Host "Installing SWA CLI..."
      npm install -g @azure/static-web-apps-cli

      Write-Host "Deploying using SWA CLI..."
      swa deploy `
        --app-location "$(Build.SourcesDirectory)/build" `
        --deployment-token $token

      Write-Host "ðŸŽ‰ Deployment SUCCESS!"
